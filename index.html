<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LocalMart - Shop Smart. Live Local.</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <nav class="container">
            <div class="logo">LocalMart</div>
            <ul class="nav-links">
                <li><a href="#home" class="active" onclick="clearSearchAndSetActive(this)">Home</a></li>
                <li><a href="#products" onclick="clearSearchAndSetActive(this)">Products</a></li>
                <li><a href="about.html">About</a></li>
                <li><a href="contact.html">Contact</a></li>
            </ul>
            <div style="display: flex; gap: 1rem; align-items: center;">
                <div class="search-container">
                    <input type="text" id="searchInput" placeholder="Search products..." onkeyup="handleSearch(event)">
                    <!-- Clear button inside search container -->
                    <button type="button" class="clear-search-input" id="clearSearchInput" style="display: none;" onclick="clearSearchInput()">
                        √ó
                    </button>
                    <button class="search-btn" onclick="performSearch()">üîç</button>
                </div>
                <div class="cart-icon" onclick="toggleCart()">
                    üõí Cart
                    <span class="cart-count" id="cartCount">0</span>
                </div>
                <div class="menu-toggle" onclick="toggleSidebar()">‚ò∞</div>
            </div>
        </nav>
    </header>
    <section class="hero" id="home">
        <div class="container">
            <h1>LocalMart</h1>
            <p>Shop Smart. Live Local.</p>
        </div>
    </section>
    <section class="products-section" id="products">
        <div class="container">
            <h2 class="section-title" id="sectionTitle">Featured Products</h2>
            <!-- Search Results Info -->
            <div class="search-results-info" id="searchResultsInfo" style="display: none;">
                <p id="searchResultsText"></p>
                <button class="clear-search-btn" onclick="clearSearch()">Show All Products</button>
            </div>
            <!-- Advanced Search Filters -->
            <div class="search-filters" id="searchFilters" style="display: none;">
                <div class="filter-group">
                    <label for="sortSelect">Sort by:</label>
                    <select id="sortSelect" onchange="applyFilters()">
                        <option value="name">Name (A-Z)</option>
                        <option value="price_low">Price (Low to High)</option>
                        <option value="price_high">Price (High to Low)</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="minPrice">Min Price:</label>
                    <input type="number" id="minPrice" placeholder="0" min="0" onchange="applyFilters()">
                </div>
                <div class="filter-group">
                    <label for="maxPrice">Max Price:</label>
                    <input type="number" id="maxPrice" placeholder="1000" min="0" onchange="applyFilters()">
                </div>
            </div>
            <div class="products-grid" id="productsGrid">
                <!-- Products will be populated by JavaScript -->
            </div>
            <!-- No Results Message -->
            <div class="no-results" id="noResults" style="display: none;">
                <h3>No products found</h3>
                <p>Try adjusting your search terms or filters.</p>
            </div>
        </div>
    </section>
    <!-- Cart Modal -->
    <div class="cart-modal" id="cartModal">
        <div class="cart-content">
            <div class="cart-header">
                <h2>Shopping Cart</h2>
                <button class="close-cart" onclick="toggleCart()">√ó</button>
            </div>
            <div id="cartItems"></div>
            <div class="cart-total" id="cartTotal">Total: $0.00</div>
            <button class="checkout-btn" onclick="showOrderForm()">Proceed to Checkout</button>
        </div>
    </div>
    <!-- Order Form -->
    <div class="container">
        <div class="order-form" id="orderForm">
            <h2>Order Details</h2>
            <div class="order-summary" id="orderSummary"></div>
            <form id="checkoutForm">
                <div class="form-group">
                    <label for="customerName">Full Name *</label>
                    <input type="text" id="customerName" name="customerName" required>
                </div>
                <div class="form-group">
                    <label for="email">Email *</label>
                    <input type="email" id="email" name="email" required>
                </div>
                <div class="form-group">
                    <label for="phone">Phone Number *</label>
                    <input type="tel" id="phone" name="phone" required>
                </div>
                <div class="form-group">
                    <label for="address">Delivery Address *</label>
                    <textarea id="address" name="address" rows="3" required></textarea>
                </div>
                <div class="form-group">
                    <label for="city">City *</label>
                    <input type="text" id="city" name="city" required>
                </div>
                <div class="form-group">
                    <label for="notes">Special Instructions (Optional)</label>
                    <textarea id="notes" name="notes" rows="2"></textarea>
                </div>
                <button type="submit" class="submit-order">Place Order (Cash on Delivery)</button>
            </form>
            <div class="success-message" id="successMessage">
                <h3>Order Placed Successfully! üéâ</h3>
                <p>Your order will be delivered within 2-3 business days. Payment will be collected upon delivery.</p>
            </div>
        </div>
    </div>
    <!-- Sidebar -->
    <div id="sidebar" class="sidebar">
        <div class="sidebar-content">
            <div class="close-btn" onclick="toggleSidebar()">√ó</div>
            <ul id="sidebarMenu">
                <!-- JS will insert login/logout dynamically -->
            </ul>
        </div>
    </div>
    <script>
        // Products will be loaded from MySQL database
        let products = [];
        let allProducts = []; // Store original products list
        let cart = [];
        let isSearchActive = false;
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            const navLinks = document.querySelectorAll('.nav-links a');
            navLinks.forEach(link => {
                link.addEventListener('click', function() {
                    // Remove active class from all links
                    navLinks.forEach(l => l.classList.remove('active'));
                    // Add active class to clicked link
                    this.classList.add('active');
                });
            });
            loadProducts();
            loadCart();
            renderSidebarMenu();
            
            // Add event listener for search input to show/hide clear button
            const searchInput = document.getElementById('searchInput');
            const clearSearchInput = document.getElementById('clearSearchInput');
            
            searchInput.addEventListener('input', function() {
                clearSearchInput.style.display = this.value ? 'flex' : 'none';
            });
        });
        
        function clearSearchAndSetActive(element) {
            // Clear the search
            clearSearch();
            
            // Update active navigation link
            const navLinks = document.querySelectorAll('.nav-links a');
            navLinks.forEach(link => link.classList.remove('active'));
            element.classList.add('active');
        }

        function toggleSidebar() {
            const sidebar = document.getElementById("sidebar");
            sidebar.classList.toggle("open");
        }
        // Render sidebar menu dynamically based on session
        async function renderSidebarMenu() {
            try {
                const res = await fetch('session_check.php');
                const data = await res.json();
                const menu = document.getElementById("sidebarMenu");
                menu.innerHTML = '';
                if (data.loggedIn && data.user) {
                    menu.innerHTML = `
                        <li style="border-bottom: 1px solid #1c1f2a; font-weight: bold; color: #1c1f2a;">
                            Welcome, ${data.user.name}!
                        </li>
                        <li><a href="logout.php">Logout</a></li>
                    `;
                } else {
                    menu.innerHTML = `
                        <li><a href="login_register.html">Login / Register</a></li>
                    `;
                }
            } catch (e) {
                console.error("Sidebar session check failed", e);
            }
        }
        // Search Functions
        function handleSearch(event) {
            if (event.key === 'Enter') {
                performSearch();
            }
        }
        
        function clearSearchInput() {
            document.getElementById('searchInput').value = '';
            document.getElementById('clearSearchInput').style.display = 'none';
            // Don't perform search, just clear the input
        }
        
        async function performSearch() {
            const searchTerm = document.getElementById('searchInput').value.trim();
            if (searchTerm.length === 0) {
                clearSearch();
                return;
            }
            try {
                const response = await fetch(`products.php?search=${encodeURIComponent(searchTerm)}`);
                const data = await response.json();
                if (data.success !== false) {
                    const searchResults = data.products || data;
                    products = searchResults;
                    isSearchActive = true;
                    displayProducts();
                    updateSearchResultsInfo(searchTerm, searchResults.length);
                    showSearchFilters();
                } else {
                    console.error('Search error:', data.error);
                    showNoResults();
                }
            } catch (error) {
                console.error('Error performing search:', error);
                showNoResults();
            }
        }
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('clearSearchInput').style.display = 'none';
            isSearchActive = false;
            products = [...allProducts];
            displayProducts();
            hideSearchFilters();
            hideSearchResultsInfo();
            hideNoResults();
            document.getElementById('sectionTitle').textContent = 'Featured Products';
        }
        function updateSearchResultsInfo(searchTerm, resultCount) {
            const resultsInfo = document.getElementById('searchResultsInfo');
            const resultsText = document.getElementById('searchResultsText');
            resultsText.textContent = `Found ${resultCount} result(s) for "${searchTerm}"`;
            resultsInfo.style.display = 'block';
            document.getElementById('sectionTitle').textContent = 'Search Results';
        }
        function hideSearchResultsInfo() {
            document.getElementById('searchResultsInfo').style.display = 'none';
        }
        function showSearchFilters() {
            document.getElementById('searchFilters').style.display = 'flex';
        }
        function hideSearchFilters() {
            document.getElementById('searchFilters').style.display = 'none';
            // Reset filter values
            document.getElementById('sortSelect').value = 'name';
            document.getElementById('minPrice').value = '';
            document.getElementById('maxPrice').value = '';
        }
        function showNoResults() {
            document.getElementById('noResults').style.display = 'block';
            document.getElementById('productsGrid').style.display = 'none';
        }
        function hideNoResults() {
            document.getElementById('noResults').style.display = 'none';
            document.getElementById('productsGrid').style.display = 'grid';
        }
        async function applyFilters() {
            if (!isSearchActive) return;
            const searchTerm = document.getElementById('searchInput').value.trim();
            const sortBy = document.getElementById('sortSelect').value;
            const minPrice = document.getElementById('minPrice').value || 0;
            const maxPrice = document.getElementById('maxPrice').value || 999999;
            try {
                const url = `search.php?q=${encodeURIComponent(searchTerm)}&sort=${sortBy}&min_price=${minPrice}&max_price=${maxPrice}`;
                const response = await fetch(url);
                const data = await response.json();
                if (data.success) {
                    products = data.products;
                    displayProducts();
                    updateSearchResultsInfo(searchTerm, data.total);
                    if (data.total === 0) {
                        showNoResults();
                    } else {
                        hideNoResults();
                    }
                }
            } catch (error) {
                console.error('Error applying filters:', error);
            }
        }
        // Load products from MySQL database
        async function loadProducts() {
            try {
                const response = await fetch('products.php');
                const data = await response.json();
                if (data.error) {
                    console.error('Error loading products:', data.error);
                    // Fallback to sample data if database fails
                    products = [
                        { id: 1, name: "iPhone 21 Pro", price: 999.99, description: "Latest flagship smartphone with advanced camera and 5G connectivity", image: "default-product.jpg" },
                        { id: 2, name: "Laptop Ultra", price: 1299.99, description: "High-performance laptop for gaming and professional work", image: "default-product.jpg" },
                        { id: 3, name: "Wireless Earbuds", price: 199.99, description: "Premium wireless earbuds with noise cancellation", image: "default-product.jpg" },
                        { id: 4, name: "Smart Watch", price: 299.99, description: "Fitness tracking smartwatch with heart rate monitoring", image: "default-product.jpg" },
                        { id: 5, name: "Tablet Pro", price: 799.99, description: "Large screen tablet perfect for creativity and productivity", image: "default-product.jpg" },
                        { id: 6, name: "Gaming Console", price: 499.99, description: "Next-gen gaming console with 4K gaming support", image: "default-product.jpg" }
                    ];
                } else {
                    products = data;
                }
                allProducts = [...products]; // Store original list
                displayProducts();
            } catch (error) {
                console.error('Error fetching products:', error);
                // Use fallback data
                products = [
                    { id: 1, name: "iPhone 22 Pro", price: 999.99, description: "Latest flagship smartphone with advanced camera and 5G connectivity", image: "default-product.jpg" },
                    { id: 2, name: "Laptop Ultra", price: 1299.99, description: "High-performance laptop for gaming and professional work", image: "default-product.jpg" },
                    { id: 3, name: "Wireless Earbuds", price: 199.99, description: "Premium wireless earbuds with noise cancellation", image: "default-product.jpg" },
                    { id: 4, name: "Smart Watch", price: 299.99, description: "Fitness tracking smartwatch with heart rate monitoring", image: "default-product.jpg" },
                    { id: 5, name: "Tablet Pro", price: 799.99, description: "Large screen tablet perfect for creativity and productivity", image: "default-product.jpg" },
                    { id: 6, name: "Gaming Console", price: 499.99, description: "Next-gen gaming console with 4K gaming support", image: "default-product.jpg" }
                ];
                allProducts = [...products];
                displayProducts();
            }
        }
        function displayProducts() {
            const productsGrid = document.getElementById('productsGrid');
            productsGrid.innerHTML = '';
            if (products.length === 0) {
                showNoResults();
                return;
            }
            hideNoResults();
            products.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                productCard.innerHTML = `
                    <div class="product-image">
                        <img src="assets/${product.image}" alt="${product.name}" 
                             onerror="this.src='assets/default-product.jpg'">
                    </div>
                    <div class="product-info">
                        <div class="product-name">${product.name}</div>
                        <div class="product-price">$${product.price.toFixed(2)}</div>
                        <div class="product-description">${product.description}</div>
                        <button class="add-to-cart" onclick="addToCart(${product.id})">
                            Add to Cart
                        </button>
                    </div>
                `;
                productsGrid.appendChild(productCard);
            });
        }
        // Load cart from localStorage when page loads
        async function loadCart() {
            try {
                const response = await fetch('session_check.php');
                const data = await response.json();
                if (data.loggedIn) {
                    const savedCart = localStorage.getItem('cart');
                    if (savedCart) {
                        cart = JSON.parse(savedCart);
                        updateCartCount();
                    }
                } else {
                    // Clear cart if not logged in
                    cart = [];
                    localStorage.removeItem('cart');
                    updateCartCount();
                }
            } catch (error) {
                // If session check fails, clear cart
                cart = [];
                localStorage.removeItem('cart');
                updateCartCount();
            }
        }
        // Save cart to localStorage
        function saveCart() {
            localStorage.setItem('cart', JSON.stringify(cart));
        }
        function addToCart(productId) {
            const product = products.find(p => p.id === productId) || allProducts.find(p => p.id === productId);
            if (!product) return;
            const existingItem = cart.find(item => item.id === productId);
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({
                    ...product,
                    quantity: 1
                });
            }
            saveCart();
            updateCartCount();
            // Add visual feedback
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'Added! ‚úì';
            button.style.background = '#2ed573';
            setTimeout(() => {
                button.textContent = originalText;
                button.style.background = '#1c1f2a';
            }, 1000);
        }
        function updateCartCount() {
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('cartCount').textContent = totalItems;
        }
        async function toggleCart() {
            // Check login status before showing cart
            try {
                const response = await fetch('session_check.php');
                const data = await response.json();
                if (!data.loggedIn) {
                    alert('Please login to view your cart!');
                    window.location.href = 'login_register.html';
                    return;
                }
            } catch (error) {
                alert('Please login to view your cart!');
                window.location.href = 'login_register.html';
                return;
            }
            const modal = document.getElementById('cartModal');
            if (modal.style.display === 'block') {
                modal.style.display = 'none';
            } else {
                modal.style.display = 'block';
                displayCartItems();
            }
        }
        function displayCartItems() {
            const cartItems = document.getElementById('cartItems');
            const cartTotal = document.getElementById('cartTotal');
            if (cart.length === 0) {
                cartItems.innerHTML = '<p>Your cart is empty</p>';
                cartTotal.textContent = 'Total: $0.00';
                return;
            }
            cartItems.innerHTML = '';
            let total = 0;
            cart.forEach(item => {
                const cartItem = document.createElement('div');
                cartItem.className = 'cart-item';
                cartItem.innerHTML = `
                    <div>
                        <strong>${item.name}</strong><br>
                        $${item.price.toFixed(2)} each
                    </div>
                    <div class="quantity-controls">
                        <button class="quantity-btn" onclick="changeQuantity(${item.id}, -1)">-</button>
                        <span>${item.quantity}</span>
                        <button class="quantity-btn" onclick="changeQuantity(${item.id}, 1)">+</button>
                        <button class="quantity-btn" onclick="removeFromCart(${item.id})" style="background: #ff4757; margin-left: 10px;">√ó</button>
                    </div>
                `;
                cartItems.appendChild(cartItem);
                total += item.price * item.quantity;
            });
            cartTotal.textContent = `Total: $${total.toFixed(2)}`;
        }
        function changeQuantity(productId, change) {
            const item = cart.find(item => item.id === productId);
            if (item) {
                item.quantity += change;
                if (item.quantity <= 0) {
                    removeFromCart(productId);
                } else {
                    saveCart(); 
                    updateCartCount();
                    displayCartItems();
                }
            }
        }
        function removeFromCart(productId) {
            cart = cart.filter(item => item.id !== productId);
            saveCart();
            updateCartCount();
            displayCartItems();
        }
        async function showOrderForm() {
            if (cart.length === 0) {
                alert('Your cart is empty!');
                return;
            }
            toggleCart();
            document.getElementById('orderForm').style.display = 'block';
            document.getElementById('orderForm').scrollIntoView({ behavior: 'smooth' });
            // Display order summary
            const orderSummary = document.getElementById('orderSummary');
            let summaryHTML = '<h3>Order Summary</h3>';
            let total = 0;
            cart.forEach(item => {
                summaryHTML += `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span>${item.name} x${item.quantity}</span>
                        <span>$${(item.price * item.quantity).toFixed(2)}</span>
                    </div>
                `;
                total += item.price * item.quantity;
            });
            summaryHTML += `
                <div style="border-top: 2px solid #667eea; padding-top: 10px; margin-top: 10px;">
                    <strong>Total: $${total.toFixed(2)}</strong>
                </div>
            `;
            orderSummary.innerHTML = summaryHTML;
            // Auto-fill user data
            try {
                const response = await fetch('session_check.php');
                const data = await response.json();
                if (data.loggedIn && data.user) {
                    document.getElementById('customerName').value = data.user.name || '';
                    document.getElementById('email').value = data.user.email || '';
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }
        document.getElementById('checkoutForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            // Get form data
            const formData = new FormData(this);
            const orderData = {
                customer: {
                    name: formData.get('customerName'),
                    email: formData.get('email'),
                    phone: formData.get('phone'),
                    address: formData.get('address'),
                    city: formData.get('city'),
                    notes: formData.get('notes')
                },
                items: cart,
                total: cart.reduce((sum, item) => sum + (item.price * item.quantity), 0),
                orderDate: new Date().toISOString(),
                paymentMethod: 'Cash on Delivery'
            };
            try {
                // Send order to PHP backend
                const response = await fetch('submit_order.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(orderData)
                });
                const result = await response.json();
                if (result.success) {
                    // Clear cart
                    cart = [];
                    localStorage.removeItem('cart');
                    updateCartCount();
                    // Show success message
                    document.getElementById('checkoutForm').style.display = 'none';
                    document.getElementById('successMessage').style.display = 'block';
                    // Reset form after showing success
                    setTimeout(() => {
                        document.getElementById('orderForm').style.display = 'none';
                        document.getElementById('successMessage').style.display = 'none';
                        document.getElementById('checkoutForm').style.display = 'block';
                        document.getElementById('checkoutForm').reset();
                    }, 5000);
                } else {
                    alert('Error placing order: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error submitting order:', error);
                alert('Error submitting order. Please try again.');
            }
        });
        // Close modal when clicking outside
        document.getElementById('cartModal').addEventListener('click', function (e) {
            if (e.target === this) {
                toggleCart();
            }
        });
    </script>
</body>
</html>